#!/bin/bash

# ==============================================================================
# SenTient Startup Script (Linux/macOS)
# ==============================================================================
# Role: Bootloader for the Java Core Orchestrator (Layer 3).
# Version: 1.0.0-RC3
# Usage: ./refine
# ==============================================================================

# 1. Resolve Home Directory
# ------------------------------------------------------------------------------
# Get the physical path of this script to establish SENTIENT_HOME
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do # resolve $SOURCE until the file is no longer a symlink
  DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE" # if $SOURCE was a relative symlink, resolve relative to the path where the symlink file was located
done
DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"

export REFINE_HOME="$DIR"

# 2. Load Configuration
# ------------------------------------------------------------------------------
# Read JVM arguments (Memory, GC) from refine.ini
if [ -f "$REFINE_HOME/refine.ini" ]; then
    source "$REFINE_HOME/refine.ini"
fi

# Set defaults if refine.ini is missing
# [ALIGNMENT] Default to 4GB to match 'Hybrid Memory Architecture' specs
if [ -z "$REFINE_MEMORY" ]; then
    REFINE_MEMORY="4096M"
fi

# [ALIGNMENT] Enforce Golden Variables:
# - UseG1GC: Low pause collection for batch processing
# - refine.host/port: Strict binding to 127.0.0.1:3333 (Security)
# - refine.headless: Disable AWT, purely API/Server mode
if [ -z "$JAVA_OPTIONS" ]; then
    JAVA_OPTIONS="-XX:+UseG1GC -Drefine.headless=true -Drefine.host=127.0.0.1 -Drefine.port=3333"
fi

# 3. Java Environment Check
# ------------------------------------------------------------------------------
if [ -z "$JAVA_HOME" ]; then
    JAVA="java"
else
    JAVA="$JAVA_HOME/bin/java"
fi

# Verify Java 17+
JAVA_VERSION=$("$JAVA" -version 2>&1 | awk -F '"' '/version/ {print $2}')
echo "SenTient Bootloader: Found Java version $JAVA_VERSION"

# 4. Construct Classpath
# ------------------------------------------------------------------------------
# We must include:
# - The Servlet Container (Jetty)
# - The Core Application (Refine)
# - The New Storage Drivers (DuckDB Sidecar)
# - The Extensions (Wikibase, Solr Client)

CP=""

# Add Core Libraries
for jar in "$REFINE_HOME"/server/lib/*.jar; do
    if [ -z "$CP" ]; then CP="$jar"; else CP="$CP:$jar"; fi
done

# Add Webapp Libraries (Core Logic)
for jar in "$REFINE_HOME"/webapp/WEB-INF/lib/*.jar; do
    CP="$CP:$jar"
done

# Add Extension Libraries (DuckDB, Solr, Wikibase)
# Note: 'extensions' folder layout is usually extensions/name/module/lib/
for jar in "$REFINE_HOME"/extensions/*/module/lib/*.jar; do
    CP="$CP:$jar"
done

# 5. Launch Orchestrator
# ------------------------------------------------------------------------------
echo "Starting SenTient Core..."
echo "  Memory:  $REFINE_MEMORY"
echo "  Home:    $REFINE_HOME"
echo "  Binding: 127.0.0.1:3333"

exec "$JAVA" \
    -cp "$CP" \
    $JAVA_OPTIONS \
    -Xms"$REFINE_MEMORY" -Xmx"$REFINE_MEMORY" \
    -Drefine.home="$REFINE_HOME" \
    -Drefine.webapp="$REFINE_HOME/webapp" \
    com.google.refine.Refine